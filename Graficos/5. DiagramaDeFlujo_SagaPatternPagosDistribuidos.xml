<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2024-01-15T10:00:00.000Z" agent="5.0" version="22.1.16" etag="example" type="device">
  <diagram name="Saga Pattern - Pago Distribuido" id="saga_pattern_flow">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1654" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- TITLE -->
        <mxCell id="title" value="SAGA PATTERN - PAGO DISTRIBUIDO SERVICIUDAD" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=18;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="40" width="1520" height="60" as="geometry" />
        </mxCell>
        
        <!-- ACTORS -->
        <mxCell id="ciudadano" value="Ciudadano" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;outlineConnect=0;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="80" y="140" width="30" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="api_gateway" value="API Gateway" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="180" y="140" width="100" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="ms_pagos" value="MS-Pagos&#xa;(Saga Orchestrator)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="340" y="140" width="120" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="ms_clientes" value="MS-Clientes" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="520" y="140" width="100" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="pasarela_pse" value="Pasarela PSE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="680" y="140" width="100" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="adaptador_mainframe" value="Adaptador&#xa;Mainframe" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="840" y="140" width="100" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="adaptador_oracle" value="Adaptador&#xa;Oracle" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1000" y="140" width="100" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="ms_notificaciones" value="MS-Notificaciones" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1160" y="140" width="100" height="60" as="geometry" />
        </mxCell>
        
        <!-- LIFELINES -->
        <mxCell id="lifeline1" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="95" y="220" as="sourcePoint" />
            <mxPoint x="95" y="1100" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="lifeline2" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="230" y="220" as="sourcePoint" />
            <mxPoint x="230" y="1100" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="lifeline3" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="220" as="sourcePoint" />
            <mxPoint x="400" y="1100" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="lifeline4" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="570" y="220" as="sourcePoint" />
            <mxPoint x="570" y="1100" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="lifeline5" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="730" y="220" as="sourcePoint" />
            <mxPoint x="730" y="1100" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="lifeline6" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="890" y="220" as="sourcePoint" />
            <mxPoint x="890" y="1100" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="lifeline7" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1050" y="220" as="sourcePoint" />
            <mxPoint x="1050" y="1100" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="lifeline8" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1210" y="220" as="sourcePoint" />
            <mxPoint x="1210" y="1100" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- SAGA HAPPY PATH -->
        <mxCell id="step1" value="1. POST /pagos/serviciudad&#xa;{energia: 150000, agua: 80000, cliente: '12345'}" style="endArrow=classic;html=1;strokeColor=#d6b656;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="95" y="250" as="sourcePoint" />
            <mxPoint x="230" y="250" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step2" value="2. Enrutar a MS-Pagos" style="endArrow=classic;html=1;strokeColor=#d6b656;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="230" y="280" as="sourcePoint" />
            <mxPoint x="400" y="280" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step3" value="3. Iniciar Saga: PagoServiCiudadSaga" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="320" y="300" width="160" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step4" value="4. Validar Cliente ServiCiudad" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="350" as="sourcePoint" />
            <mxPoint x="570" y="350" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step5" value="✅ Cliente Válido" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="570" y="380" as="sourcePoint" />
            <mxPoint x="400" y="380" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step6" value="5. Procesar Pago PSE" style="endArrow=classic;html=1;strokeColor=#9673a6;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="420" as="sourcePoint" />
            <mxPoint x="730" y="420" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step7" value="✅ Pago Autorizado&#xa;TransactionId: TXN123" style="endArrow=classic;html=1;strokeColor=#9673a6;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="730" y="460" as="sourcePoint" />
            <mxPoint x="400" y="460" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step8" value="6. Actualizar Saldo Energía" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="500" as="sourcePoint" />
            <mxPoint x="890" y="500" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step9" value="✅ Saldo Actualizado" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="890" y="530" as="sourcePoint" />
            <mxPoint x="400" y="530" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step10" value="7. Actualizar Saldo Agua" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="570" as="sourcePoint" />
            <mxPoint x="1050" y="570" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step11" value="✅ Saldo Actualizado" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1050" y="600" as="sourcePoint" />
            <mxPoint x="400" y="600" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step12" value="8. Enviar Notificación" style="endArrow=classic;html=1;strokeColor=#d6b656;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="640" as="sourcePoint" />
            <mxPoint x="1210" y="640" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step13" value="✅ SMS/Email Enviado" style="endArrow=classic;html=1;strokeColor=#d6b656;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1210" y="670" as="sourcePoint" />
            <mxPoint x="400" y="670" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step14" value="9. Saga Completada" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="320" y="700" width="160" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="step15" value="10. HTTP 200 OK&#xa;{status: 'SUCCESS', transactionId: 'TXN123'}" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="750" as="sourcePoint" />
            <mxPoint x="230" y="750" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="step16" value="11. Respuesta Final" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="230" y="780" as="sourcePoint" />
            <mxPoint x="95" y="780" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- ROLLBACK SCENARIO -->
        <mxCell id="rollback_title" value="ESCENARIO DE ROLLBACK - FALLA EN ACTUALIZACIÓN ORACLE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="820" width="1200" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="rb_step1" value="❌ 7. Falla Actualizar Agua (Oracle)" style="endArrow=classic;html=1;strokeColor=#b85450;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="870" as="sourcePoint" />
            <mxPoint x="1050" y="870" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="rb_step2" value="❌ ERROR: Timeout 30s" style="endArrow=classic;html=1;strokeColor=#b85450;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1050" y="900" as="sourcePoint" />
            <mxPoint x="400" y="900" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="rb_step3" value="8. Iniciar Rollback" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="320" y="920" width="160" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="rb_step4" value="9. Compensar Saldo Energía" style="endArrow=classic;html=1;strokeColor=#b85450;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="970" as="sourcePoint" />
            <mxPoint x="890" y="970" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="rb_step5" value="✅ Saldo Revertido" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="890" y="1000" as="sourcePoint" />
            <mxPoint x="400" y="1000" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="rb_step6" value="10. Reversar Pago PSE" style="endArrow=classic;html=1;strokeColor=#b85450;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="400" y="1040" as="sourcePoint" />
            <mxPoint x="730" y="1040" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="rb_step7" value="✅ Pago Revertido" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="730" y="1070" as="sourcePoint" />
            <mxPoint x="400" y="1070" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- PATTERNS AND COMPONENTS -->
        <mxCell id="patterns_box" value="PATRONES Y COMPONENTES SAGA" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1320" y="250" width="280" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="saga_orchestrator" value="Saga Orchestrator&#xa;• Coordina todas las transacciones&#xa;• Mantiene estado de la saga&#xa;• Ejecuta compensaciones" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1320" y="300" width="280" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="saga_participants" value="Participantes de la Saga&#xa;• MS-Clientes: Validar cliente&#xa;• Pasarela PSE: Procesar pago&#xa;• Adaptador Mainframe: Actualizar energía&#xa;• Adaptador Oracle: Actualizar agua&#xa;• MS-Notificaciones: Enviar confirmación" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="1320" y="400" width="280" height="120" as="geometry" />
        </mxCell>
        
        <mxCell id="compensation_actions" value="Acciones de Compensación&#xa;• Revertir saldo energía en mainframe&#xa;• Cancelar/reversar pago en PSE&#xa;• Enviar notificación de falla&#xa;• Marcar transacción como fallida" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="1320" y="540" width="280" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="saga_state" value="Estados de la Saga&#xa;• STARTED: Saga iniciada&#xa;• IN_PROGRESS: En ejecución&#xa;• COMPENSATING: Ejecutando rollback&#xa;• COMPLETED: Exitosa&#xa;• FAILED: Fallida con compensación" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1320" y="660" width="280" height="120" as="geometry" />
        </mxCell>
        
        <mxCell id="resilience_patterns" value="Patrones de Resiliencia&#xa;• Circuit Breaker: En adaptadores&#xa;• Timeout: 30s máximo por operación&#xa;• Retry: 3 intentos con backoff&#xa;• Fallback: Usar datos en caché&#xa;• Bulkhead: Aislar recursos por servicio" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="1320" y="800" width="280" height="120" as="geometry" />
        </mxCell>
        
        <!-- LEGEND -->
        <mxCell id="legend_box" value="LEYENDA" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="60" y="1120" width="1200" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="legend_success" value="→ Línea Sólida: Llamada exitosa" style="endArrow=classic;html=1;strokeColor=#82b366;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="80" y="1170" as="sourcePoint" />
            <mxPoint x="200" y="1170" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="legend_response" value="⟵ Línea Punteada: Respuesta" style="endArrow=classic;html=1;strokeColor=#6c8ebf;strokeWidth=2;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="280" y="1170" as="sourcePoint" />
            <mxPoint x="400" y="1170" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="legend_failure" value="→ Línea Roja: Llamada fallida/compensación" style="endArrow=classic;html=1;strokeColor=#b85450;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="480" y="1170" as="sourcePoint" />
            <mxPoint x="650" y="1170" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="legend_colors" value="🟢 Verde: Éxito | 🔵 Azul: Proceso | 🔴 Rojo: Falla | 🟡 Amarillo: MS Core" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="730" y="1160" width="530" height="30" as="geometry" />
        </mxCell>